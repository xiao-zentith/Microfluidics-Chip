Metadata-Version: 2.4
Name: microfluidics-chip
Version: 0.1.0
Summary: Microfluidic chip image processing pipeline with YOLO detection and UNet correction
Author: Microfluidics Team
License: MIT
Keywords: microfluidics,image-processing,yolo,unet,computer-vision
Requires-Python: >=3.8
Description-Content-Type: text/markdown
Requires-Dist: torch>=2.0.0
Requires-Dist: ultralytics>=8.0.0
Requires-Dist: opencv-python>=4.8.0
Requires-Dist: numpy>=1.24.0
Requires-Dist: scikit-learn>=1.2.0
Requires-Dist: tqdm>=4.65.0
Requires-Dist: pydantic>=2.0.0
Requires-Dist: pydantic-settings>=2.0.0
Requires-Dist: PyYAML>=6.0
Requires-Dist: typer>=0.9.0
Requires-Dist: rich>=13.0.0
Provides-Extra: dev
Requires-Dist: pytest>=7.0.0; extra == "dev"
Requires-Dist: pytest-cov>=4.0.0; extra == "dev"
Requires-Dist: pytest-mock>=3.10.0; extra == "dev"
Requires-Dist: black>=23.0.0; extra == "dev"
Requires-Dist: ruff>=0.1.0; extra == "dev"
Requires-Dist: mypy>=1.0.0; extra == "dev"

# Microfluidics-Chip

> å¾®æµæ§èŠ¯ç‰‡å›¾åƒå¤„ç†æµæ°´çº¿ - åŸºäº YOLO æ£€æµ‹ä¸ UNet å…‰ç…§æ ¡æ­£çš„è‡ªåŠ¨åŒ–åˆ†æç³»ç»Ÿ

[![Tests](https://img.shields.io/badge/tests-25%2F25%20passing-brightgreen)](tests/)
[![Python](https://img.shields.io/badge/python-3.10%2B-blue)](https://www.python.org/)
[![License](https://img.shields.io/badge/license-MIT-green)](LICENSE)

---

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

è‡ªåŠ¨åŒ–å¾®æµæ§èŠ¯ç‰‡å›¾åƒå¤„ç†ç³»ç»Ÿï¼ŒåŒ…å«ä¸¤é˜¶æ®µæµæ°´çº¿ï¼š

**Stage 1: ç›®æ ‡æ£€æµ‹ä¸å‡ ä½•æ ¡æ­£**
- YOLO ç›®æ ‡æ£€æµ‹è¯†åˆ« 12 ä¸ªè…”å®¤
- åå­—å‡ ä½•æ ¡æ­£ç®—æ³•å®ç°ç²¾å‡†å¯¹é½
- è‡ªåŠ¨åˆ‡ç‰‡æå–ä¸æ ‡å‡†åŒ–

**Stage 2: UNet å…‰ç…§æ ¡æ­£**
- åŒæµ UNet ç½‘ç»œè¿›è¡Œå…‰ç…§å‡åŒ€åŒ–
- ROI åŠ æƒæŸå¤±ä¼˜åŒ–æ ¸å¿ƒååº”åŒº
- ä¿ç•™å…‰è°±ä¿¡æ¯çš„è‡ªé€‚åº”æ ¡æ­£

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd Microfluidics-Chip

# åˆ›å»º conda ç¯å¢ƒ
conda create -n microfluidics python=3.10 -y
conda activate microfluidics

# å®‰è£…é¡¹ç›®ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
pip install -e .

# å®‰è£…å¼€å‘ä¾èµ–ï¼ˆå¯é€‰ï¼‰
pip install -e ".[dev]"
```

### 2. é…ç½®æƒé‡æ–‡ä»¶

å°†è®­ç»ƒå¥½çš„æƒé‡æ–‡ä»¶æ”¾ç½®åˆ° `weights/` ç›®å½•ï¼š

```
weights/
â”œâ”€â”€ yolo/
â”‚   â””â”€â”€ best.pt          # YOLO æ£€æµ‹å™¨æƒé‡
â””â”€â”€ unet/
    â””â”€â”€ best_model.pth   # UNet æ ¡æ­£å™¨æƒé‡
```

### 3. è¿è¡Œç¤ºä¾‹

```bash
# Stage1: æ£€æµ‹ä¸åˆ‡ç‰‡
python -m microfluidics_chip.pipelines.cli stage1 \
  data/chip001.png \
  -o data/experiments/stage1 \
  --adaptive

# Stage2: å…‰ç…§æ ¡æ­£
python -m microfluidics_chip.pipelines.cli stage2 \
  data/experiments/stage1/chip001 \
  -o data/experiments/stage2

# æ‰¹é‡å¤„ç†
python -m microfluidics_chip.pipelines.cli stage1-batch \
  data/images \
  -o data/experiments/batch_stage1

python -m microfluidics_chip.pipelines.cli stage2-batch \
  data/experiments/batch_stage1 \
  -o data/experiments/batch_stage2
```

---

## ğŸ“– è¯¦ç»†æ–‡æ¡£

- æ–‡æ¡£å¯¼èˆªä¸åˆ†å·¥ï¼š[`docs/README.md`](docs/README.md)
- CLI å‘½ä»¤å‚è€ƒï¼ˆå”¯ä¸€æ–‡æ¡£ï¼‰ï¼š[`docs/CLI_REFERENCE.md`](docs/CLI_REFERENCE.md)
- è¿è¡Œæ—¶çœŸå®å®šä¹‰ï¼š`python -m microfluidics_chip.pipelines.cli --help`

å¸¸ç”¨å…¥å£ï¼ˆå®Œæ•´å‚æ•°ç»„åˆè§ `docs/CLI_REFERENCE.md`ï¼‰ï¼š

```bash
# Stage1 (è‡ªé€‚åº”)
python -m microfluidics_chip.pipelines.cli stage1 data/chip001.png -o data/experiments/stage1 --adaptive

# Stage2
python -m microfluidics_chip.pipelines.cli stage2 data/experiments/stage1/chip001 -o data/experiments/stage2

# æ¶ˆèï¼šä¸¤é˜¶æ®µYOLO -> åå¤„ç†
python -m microfluidics_chip.pipelines.cli stage1-yolo-adaptive data/chip001.png -o data/experiments/stage1_yolo_adaptive
python -m microfluidics_chip.pipelines.cli stage1-post data/experiments/stage1_yolo_adaptive/chip001/adaptive_yolo_raw_detections.json -o data/experiments/stage1_post
```

å¯ç”¨ `--adaptive` æ—¶ï¼Œ`stage1_metadata.json` ä¼šé¢å¤–åŒ…å«ï¼š
- `quality_metrics`
- `quality_gate_passed`
- `detection_mode`
- `retry_attempt`

### Python API

```python
from pathlib import Path
from microfluidics_chip.core.config import get_default_config
from microfluidics_chip.pipelines.stage1 import run_stage1
from microfluidics_chip.pipelines.stage2 import run_stage2

# åŠ è½½é…ç½®
config = get_default_config()

# Stage1
stage1_output = run_stage1(
    chip_id="chip001",
    raw_image_path=Path("data/chip001.png"),
    gt_image_path=None,
    output_dir=Path("runs/stage1"),
    config=config.stage1
)

# Stage2
stage2_output = run_stage2(
    stage1_run_dir=Path("runs/stage1/chip001"),
    output_dir=Path("runs/stage2"),
    config=config.stage2
)
```

### é…ç½®æ–‡ä»¶

åˆ›å»ºè‡ªå®šä¹‰é…ç½®æ–‡ä»¶ `configs/my_config.yaml`ï¼š

```yaml
experiment_name: "my_experiment"

stage1:
  yolo:
    weights_path: "weights/yolo/best.pt"
    confidence_threshold: 0.5
    device: "cuda"
  
  geometry:
    canvas_size: 600
    slice_size: [80, 80]
    crop_radius: 25

stage2:
  weights_path: "weights/unet/best_model.pth"
  model:
    device: "cuda"
    features: [64, 128, 256, 512]
```

---

## ğŸ§ª è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/ -v

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/unit/ -v
pytest tests/integration/ -v

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/ --cov=src/microfluidics_chip --cov-report=html
```

**æµ‹è¯•è¦†ç›–**: 25/25 tests passing âœ…

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
Microfluidics-Chip/
â”œâ”€â”€ src/microfluidics_chip/          # æºä»£ç 
â”‚   â”œâ”€â”€ core/                         # æ ¸å¿ƒæ¨¡å—ï¼ˆç±»å‹ã€é…ç½®ã€IOï¼‰
â”‚   â”œâ”€â”€ stage1_detection/             # Stage1: YOLOæ£€æµ‹+å‡ ä½•æ ¡æ­£
â”‚   â”œâ”€â”€ stage2_correction/            # Stage2: UNetå…‰ç…§æ ¡æ­£
â”‚   â””â”€â”€ pipelines/                    # ä¸šåŠ¡ç¼–æ’å±‚+CLI
â”œâ”€â”€ tests/                            # æµ‹è¯•å¥—ä»¶
â”‚   â”œâ”€â”€ unit/                         # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ integration/                  # é›†æˆæµ‹è¯•
â”œâ”€â”€ configs/                          # é…ç½®æ–‡ä»¶
â”œâ”€â”€ scripts/                          # å·¥å…·è„šæœ¬
â”œâ”€â”€ weights/                          # æ¨¡å‹æƒé‡ï¼ˆä¸æäº¤ï¼‰
â”œâ”€â”€ deprecated/                       # åºŸå¼ƒä»£ç ï¼ˆv1.0ï¼‰
â””â”€â”€ docs/                             # æ–‡æ¡£

```

---

## ğŸ”§ è®­ç»ƒä¸æ•°æ®å‡†å¤‡

å®Œæ•´è®­ç»ƒæµç¨‹å·²ç»Ÿä¸€åˆ°ä¸“é¢˜æ–‡æ¡£ï¼Œé¿å…ä¸ `docs/DATA_PREPARATION.md` é‡å¤ç»´æŠ¤ï¼š

- Stage1/Stage2 æ•°æ®å‡†å¤‡ä¸è®­ç»ƒï¼š[`docs/DATA_PREPARATION.md`](docs/DATA_PREPARATION.md)
- Stage1 è‡ªé€‚åº”ä¸æ‹“æ‰‘åå¤„ç†ï¼š[`docs/ADAPTIVE_DETECTION.md`](docs/ADAPTIVE_DETECTION.md)
- Stage2 å¢å¼ºç­–ç•¥ï¼š[`docs/UNET_AUGMENTATION.md`](docs/UNET_AUGMENTATION.md)

æœ€å°è®­ç»ƒé—­ç¯ï¼ˆç¤ºä¾‹ï¼‰ï¼š

```bash
# 1) å‡†å¤‡ Stage2 è®­ç»ƒæ•°æ®
python scripts/prepare_training_data.py dataset/training -o data/training.npz

# 2) è®­ç»ƒ Stage2
python scripts/train_stage2.py data/training.npz -o runs/training --epochs 100
```

---

## ğŸ“Š è¾“å‡ºæ ¼å¼

### Stage1 è¾“å‡º

```
runs/stage1/chip001/
â”œâ”€â”€ stage1_metadata.json      # å…ƒæ•°æ®ï¼ˆæ£€æµ‹æ•°ã€å¤„ç†æ—¶é—´ç­‰ï¼‰
â”œâ”€â”€ aligned.png                # å¯¹é½åçš„å®Œæ•´å›¾åƒ
â”œâ”€â”€ chamber_slices.npz         # 12ä¸ªåˆ‡ç‰‡ï¼ˆkey='slices'ï¼‰
â”œâ”€â”€ debug_detection.png        # æ£€æµ‹å¯è§†åŒ–ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ slices/                    # å•ä¸ªåˆ‡ç‰‡å›¾åƒï¼ˆå¯é€‰ï¼‰
    â”œâ”€â”€ 0_raw.jpg
    â”œâ”€â”€ 1_raw.jpg
    â””â”€â”€ ...
```

### Stage2 è¾“å‡º

```
runs/stage2/chip001/
â”œâ”€â”€ stage2_metadata.json       # å…ƒæ•°æ®
â””â”€â”€ corrected_slices.npz       # æ ¡æ­£åçš„åˆ‡ç‰‡ï¼ˆkey='slices'ï¼‰
```

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### 1. YOLO æƒé‡æ–‡ä»¶æ‰¾ä¸åˆ°

**é”™è¯¯**: `FileNotFoundError: weights/yolo/best.pt`

**è§£å†³**: 
- ç¡®ä¿æƒé‡æ–‡ä»¶åœ¨ `weights/yolo/best.pt`
- æˆ–ä¿®æ”¹ `configs/default.yaml` ä¸­çš„ `weights_path`

### 2. OpenMP åº“å†²çªè­¦å‘Š

**é”™è¯¯**: `OMP: Error #15: Initializing libiomp5md.dll`

**è§£å†³**:
```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export KMP_DUPLICATE_LIB_OK=TRUE  # Linux/Mac
set KMP_DUPLICATE_LIB_OK=TRUE     # Windows
```

### 3. CUDA ä¸å¯ç”¨

**é”™è¯¯**: `cuda not available`

**è§£å†³**: ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå°† `device: "cuda"` æ”¹ä¸º `device: "cpu"`

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ï¼è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

**ä»£ç è§„èŒƒ**:
```bash
# æ ¼å¼åŒ–ä»£ç 
black src/ tests/

# ç±»å‹æ£€æŸ¥
mypy src/

# Lint æ£€æŸ¥
ruff check src/
```

---

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

---

## ğŸ“§ è”ç³»æ–¹å¼

- **é¡¹ç›®ç»´æŠ¤**: Microfluidics Team
- **é—®é¢˜åé¦ˆ**: [Issues](../../issues)

---

## ğŸ™ è‡´è°¢

- [Ultralytics YOLO](https://github.com/ultralytics/ultralytics) - ç›®æ ‡æ£€æµ‹æ¡†æ¶
- [PyTorch](https://pytorch.org/) - æ·±åº¦å­¦ä¹ æ¡†æ¶
- [OpenCV](https://opencv.org/) - å›¾åƒå¤„ç†åº“
