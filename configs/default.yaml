# 微流控芯片项目默认配置
# Microfluidics Chip Default Configuration

experiment_name: "microfluidics_default"

# 路径配置
paths:
  data_dir: "data"
  stage1_data: "data/stage1_detection"    # Stage1 YOLO训练数据
  stage2_data: "data/stage2_correction/microfluidics_v2" # Stage2 UNet数据 (v1)
  runs_dir: "data/experiments"
  weights_dir: "weights"

# Stage1: 目标检测与几何校正
stage1:
  yolo:
    weights_path: "weights/yolo/best4.pt"  # YOLO detection weights path
    device: "cuda"
    confidence_threshold: 0.2
    class_id_blank: 0
    class_id_lit: 1
  
  geometry:
    canvas_size: 600
    slice_size: [80, 80]
    ideal_center_gap: 60
    ideal_chamber_step: 50
    crop_radius: 25
    class_id_blank: 0
    class_id_lit: 1

  # 自适应检测参数（粗到精）
  adaptive_detection:
    coarse_imgsz: 640
    coarse_conf: 0.08
    fine_imgsz: 1280
    fine_conf: 0.3
    cluster_eps: 100.0
    cluster_min_samples: 3
    roi_margin: 1.3
    min_roi_size: 200
    enable_clahe: true
    clahe_clip_limit: 2.0

  # 拓扑拟合参数
  topology:
    template_scale: 50.0
    template_path: null
    ransac_iters: 200
    ransac_threshold: 25.0
    min_inliers: 4
    visibility_margin: 10
    brightness_roi_size: 30
    dark_percentile: 25.0
    fallback_to_affine: true

  # 自适应运行策略（默认关闭，按需通过 CLI 或配置启用）
  adaptive_runtime:
    enabled: false
    max_attempts: 3
    preprocess_sequence: ["raw", "clahe", "clahe_invert"]
    require_fit_success: true
    min_detections: 8
    min_inlier_ratio: 0.4
    max_reprojection_error: 35.0
    min_cluster_score: 0.2
    min_mean_confidence: 0.15
    confidence_decay: 0.85
    min_coarse_conf: 0.03
    min_fine_conf: 0.12
    fine_imgsz_step: 128
    fallback_to_standard: true
    force_blank_if_missing: true

# Stage2: UNet光照校正
stage2:
  model:
    model_type: "dual_stream"
    in_channels: 3
    out_channels: 3
    features: [64, 128, 256, 512]
    device: "cuda"
  
  loss:
    roi_radius: 20
    edge_weight: 0.1
    lambda_cos: 0.2
  
  weights_path: "weights/unet/best_model.pth"  # UNet correction weights path
  
  # 训练数据配置（用于对比实验）
  reference_chambers: [0, 1, 2]  # 基准腔室索引：[0]=仅空白腔, [0,1,2]=3个基准腔
  reference_mode: "stack"         # 组合模式：stack=堆叠, average=平均
