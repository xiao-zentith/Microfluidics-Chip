# Stage2è®­ç»ƒæ”¹è¿›æŒ‡å—

> **ç›®æ ‡**: PSNRä»13dBæå‡è‡³30+dB
>
> **æ–‡æ¡£è¾¹ç•Œ**:
> - æœ¬æ–‡æ¡£èšç„¦ Stage2 è®­ç»ƒæ”¹è¿›ç­–ç•¥ä¸å®éªŒå»ºè®®ã€‚
> - æ•°æ®å‡†å¤‡ä¸åŸºçº¿è®­ç»ƒè¯·çœ‹ [`docs/DATA_PREPARATION.md`](./DATA_PREPARATION.md)ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install albumentations
```

### 2. è¿è¡Œæ”¹è¿›çš„è®­ç»ƒ

```bash
# ä½¿ç”¨ç°æœ‰æ•°æ®ï¼ˆchip001ï¼‰
python scripts/train_stage2_improved.py \
    runs/quick_validation/data.npz \
    -o runs/improved_v1 \
    -e 100

# å®Œæ•´å‚æ•°ç¤ºä¾‹
python scripts/train_stage2_improved.py \
    runs/quick_validation/data.npz \
    --output runs/improved_v1 \
    --epochs 100 \
    --batch-size 8 \
    --lr 0.0003 \
    --roi-radius 25 \
    --edge-weight 0.3 \
    --lambda-cos 0.5 \
    --augment  # å¯ç”¨æ•°æ®å¢å¼ºï¼ˆé»˜è®¤å¼€å¯ï¼‰
```

**é¢„è®¡è®­ç»ƒæ—¶é—´**: 2-4å°æ—¶ï¼ˆGPUï¼‰

---

## ğŸ“Š æ”¹è¿›å¯¹æ¯”

| é¡¹ç›® | åŸå§‹è®­ç»ƒ | æ”¹è¿›è®­ç»ƒ |
|------|---------|---------|
| **Epochs** | 20 | **100** |
| **Batch Size** | 16 | **8** (æ›´ç¨³å®š) |
| **Learning Rate** | 1e-4 | **3e-4** (æ›´å¿«æ”¶æ•›) |
| **ROI Radius** | 20 | **25** (æ›´å¤§èŒƒå›´) |
| **Edge Weight** | 0.1 | **0.3** (å‡å°‘æ¨¡ç³Š) |
| **Lambda Cos** | 0.2 | **0.5** (æ›´å¥½å…‰è°±) |
| **Data Augment** | âŒ | **âœ…** (6ç§å¢å¼º) |
| **è®­ç»ƒæ ·æœ¬** | 121 | **~726** (å¢å¼º) |
| **éªŒè¯æ ·æœ¬** | 14 | **14** (åŸå§‹) |

---

## ğŸ¯ é¢„æœŸç»“æœ

### ä¿å®ˆä¼°è®¡ï¼ˆå•èŠ¯ç‰‡æ•°æ®ï¼‰
- **PSNR**: 20-25 dB
- **è§†è§‰è´¨é‡**: æ˜æ˜¾æ”¹å–„ï¼Œä½†å¯èƒ½ä»æœ‰è½»å¾®æ¨¡ç³Š

### ç†æƒ³æƒ…å†µï¼ˆå¤šèŠ¯ç‰‡æ•°æ®ï¼‰
- **PSNR**: 30+ dB
- **è§†è§‰è´¨é‡**: æ¥è¿‘Ground Truth

---

## ğŸ“ˆ ç›‘æ§è®­ç»ƒè¿›åº¦

### å®æ—¶æŸ¥çœ‹
```bash
# æŸ¥çœ‹è®­ç»ƒæ›²çº¿
runs/improved_v1/training_curves.png

# æŸ¥çœ‹å¯è§†åŒ–ç»“æœ
runs/improved_v1/epoch_10_vis.png
runs/improved_v1/epoch_20_vis.png
...
```

### å…³é”®æŒ‡æ ‡
1. **Val PSNR ä¸Šå‡è¶‹åŠ¿** - ç›®æ ‡ï¼šæŒç»­ä¸Šå‡
2. **Val Loss ä¸‹é™** - åº”ç¨³å®šåœ¨ < 0.02
3. **å¯è§†åŒ–æ¸…æ™°åº¦** - å¯¹æ¯”"Ours Output"å’Œ"Ground Truth"

---

## âš™ï¸ å¦‚æœç»“æœä¸æ»¡æ„

### æ–¹æ¡ˆAï¼šè°ƒæ•´æ•°æ®å¢å¼ºå¼ºåº¦

```bash
# ä¿®æ”¹ dataset.py ä¸­çš„å¢å¼ºå‚æ•°
A.RandomBrightnessContrast(
    brightness_limit=0.2,  # ä»0.1å¢åŠ åˆ°0.2
    contrast_limit=0.2,
    p=0.7  # ä»0.5å¢åŠ åˆ°0.7
)
```

### æ–¹æ¡ˆBï¼šæ·»åŠ æ›´å¤šæ•°æ®

```bash
# 1. å‡†å¤‡æ›´å¤šèŠ¯ç‰‡æ•°æ®
dataset/
â”œâ”€â”€ chip001/
â”œâ”€â”€ chip002/  # æ–°å¢
â”œâ”€â”€ chip003/  # æ–°å¢
â””â”€â”€ ...

# 2. é‡æ–°å‡†å¤‡æ•°æ®
python scripts/prepare_training_data.py dataset -o data/all_chips.npz

# 3. é‡æ–°è®­ç»ƒ
python scripts/train_stage2_improved.py data/all_chips.npz -o runs/improved_v2
```

### æ–¹æ¡ˆCï¼šè°ƒæ•´æŸå¤±æƒé‡

```bash
# å¢åŠ ä½™å¼¦æŸå¤±æƒé‡ï¼ˆæ›´æ³¨é‡å…‰è°±ä¿çœŸï¼‰
python scripts/train_stage2_improved.py \
    data.npz \
    -o runs/improved_v3 \
    --lambda-cos 0.7 \  # ä»0.5å¢åŠ åˆ°0.7
    --edge-weight 0.4   # ä»0.3å¢åŠ åˆ°0.4
```

---

## ğŸ“ è®­ç»ƒæ—¥å¿—è§£è¯»

### æ­£å¸¸è®­ç»ƒ
```
Epoch 10/100 - Train Loss: 0.025 | Val Loss: 0.03 | Val PSNR: 22.5 dB
Epoch 20/100 - Train Loss: 0.018 | Val Loss: 0.025 | Val PSNR: 25.3 dB â¬†
Epoch 30/100 - Train Loss: 0.015 | Val Loss: 0.022 | Val PSNR: 27.8 dB â¬†
```
âœ… **æ­£å¸¸** - PSNRæŒç»­ä¸Šå‡

### è¿‡æ‹Ÿåˆè­¦å‘Š
```
Epoch 40/100 - Train Loss: 0.01 | Val Loss: 0.028 | Val PSNR: 26.5 dB â¬‡
```
âš ï¸ **è¿‡æ‹Ÿåˆ** - Val Lossä¸Šå‡ï¼Œéœ€è¦æ—©åœ

### æ¬ æ‹Ÿåˆ
```
Epoch 50/100 - Train Loss: 0.04 | Val Loss: 0.045 | Val PSNR: 18.2 dB
```
âŒ **æ¬ æ‹Ÿåˆ** - Lossè¿‡é«˜ï¼Œéœ€è¦ï¼š
1. å¢åŠ æ¨¡å‹å®¹é‡
2. é™ä½æ­£åˆ™åŒ–
3. å¢åŠ è®­ç»ƒæ—¶é—´

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1: "albumentations not installed"
```bash
pip install albumentations
```

### é—®é¢˜2: GPUå†…å­˜ä¸è¶³
```bash
# å‡å°batch size
--batch-size 4  # ä»8å‡åˆ°4
```

### é—®é¢˜3: è®­ç»ƒå¤ªæ…¢
```bash
# å‡å°‘workers
--workers 2  # ä»4å‡åˆ°2

# æˆ–å‡å°‘å¯è§†åŒ–é¢‘ç‡
--visualize-every 20  # ä»10æ”¹åˆ°20
```

### é—®é¢˜4: PSNRä¸å¢é•¿
1. æ£€æŸ¥æ•°æ®è´¨é‡ï¼ˆæ˜¯å¦æœ‰é”™è¯¯æ ‡æ³¨ï¼‰
2. å°è¯•ä¸åŒçš„å­¦ä¹ ç‡
3. æ£€æŸ¥æŸå¤±å‡½æ•°æƒé‡

---

## ğŸ“ ä¸‹ä¸€æ­¥

### å¦‚æœPSNRè¾¾åˆ°30dB
âœ… **æˆåŠŸï¼** å¯ä»¥ï¼š
1. åœ¨å®Œæ•´æµ‹è¯•é›†ä¸Šè¯„ä¼°
2. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
3. å‡†å¤‡è®ºæ–‡/æŠ¥å‘Š

### å¦‚æœPSNRåœ¨20-30dB
âš ï¸ **æ¥è¿‘ç›®æ ‡** - å»ºè®®ï¼š
1. æ·»åŠ æ›´å¤šèŠ¯ç‰‡æ•°æ®ï¼ˆæœ€é‡è¦ï¼ï¼‰
2. è®­ç»ƒæ›´é•¿æ—¶é—´ï¼ˆ150-200 epochsï¼‰
3. å°è¯•æ¨¡å‹é›†æˆï¼ˆEnsembleï¼‰

### å¦‚æœPSNR < 20dB
âŒ **éœ€è¦è°ƒæŸ¥** - å¯èƒ½åŸå› ï¼š
1. æ•°æ®è´¨é‡é—®é¢˜
2. æŸå¤±å‡½æ•°ä¸åˆé€‚
3. æ¨¡å‹æ¶æ„éœ€è¦æ”¹è¿›

---

**å…³é”®**: æ•°æ®é‡æ˜¯æœ€é‡è¦çš„å› ç´ ã€‚å¦‚æœå•èŠ¯ç‰‡æ•°æ®æ— æ³•è¾¾åˆ°30dBï¼Œ**å¼ºçƒˆå»ºè®®æ·»åŠ æ›´å¤šèŠ¯ç‰‡æ•°æ®**ã€‚
