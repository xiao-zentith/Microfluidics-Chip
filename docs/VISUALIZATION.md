# Microfluidics-Chip å¯è§†åŒ–åŠŸèƒ½æ€»ç»“

æœ¬æ–‡æ¡£æ€»ç»“é¡¹ç›®ä¸­å·²å®ç°çš„æ‰€æœ‰å¯è§†åŒ–åŠŸèƒ½ã€‚

---

## ğŸ“Š Stage1 å¯è§†åŒ–

### 1. æ£€æµ‹è°ƒè¯•å¯è§†åŒ– (`debug_detection.png`)

**ä½ç½®**: `GeometryEngine._draw_debug()` â†’ `runs/stage1/{chip_id}/debug_detection.png`

**åŠŸèƒ½**: å±•ç¤ºYOLOæ£€æµ‹ç»“æœå’Œå‡ ä½•æ ¡æ­£æ•ˆæœ

**å¯è§†åŒ–å†…å®¹**:
- ğŸ”µ **è“è‰²åœ†ç‚¹**: è…”å®¤ä¸­å¿ƒä½ç½®
- ğŸŸ¨ **é»„è‰²çŸ©å½¢æ¡†**: åˆ‡ç‰‡åŒºåŸŸè¾¹ç•Œï¼ˆcrop_radiusï¼‰
- ğŸ”´ **çº¢è‰²åœ†åœˆ + "BLANK"**: ç©ºç™½è…”ï¼ˆé”šç‚¹ï¼Œclass_id=0ï¼‰

**ä»£ç ä½ç½®**: 
- `src/microfluidics_chip/stage1_detection/geometry_engine.py:266-300`

**ç¤ºä¾‹**:
```python
# è‡ªåŠ¨ç”Ÿæˆï¼ˆé»˜è®¤å¼€å¯ï¼‰
python -m microfluidics_chip.pipelines.cli stage1 image.png -o runs/test --save-debug
```

**è¾“å‡ºç¤ºä¾‹**:
```
runs/stage1/chip001/
â””â”€â”€ debug_detection.png  # æ£€æµ‹+åˆ‡ç‰‡å¯è§†åŒ–
```

---

### 2. å•ä¸ªåˆ‡ç‰‡ä¿å­˜ (`slices/*.jpg`)

**ä½ç½®**: `save_stage1_result()` â†’ `runs/stage1/{chip_id}/slices/`

**åŠŸèƒ½**: ä¿å­˜æ¯ä¸ªè…”å®¤çš„åˆ‡ç‰‡å›¾åƒï¼ˆç”¨äºè°ƒè¯•ï¼‰

**æ–‡ä»¶å‘½å**:
- `{index}_raw.jpg`: Rawå›¾åƒåˆ‡ç‰‡
- `{index}_gt.jpg`: GTå›¾åƒåˆ‡ç‰‡ï¼ˆå¦‚æœæä¾›ï¼‰

**ä»£ç ä½ç½®**:
- `src/microfluidics_chip/core/io.py:162-168`

**ç¤ºä¾‹**:
```bash
# éœ€è¦æ˜¾å¼å¯ç”¨
python -m microfluidics_chip.pipelines.cli stage1 image.png -o runs/test --save-slices
```

**è¾“å‡ºç¤ºä¾‹**:
```
runs/stage1/chip001/slices/
â”œâ”€â”€ 0_raw.jpg   # ç©ºç™½è…”
â”œâ”€â”€ 1_raw.jpg   # è…”å®¤1
â”œâ”€â”€ 2_raw.jpg
...
â””â”€â”€ 11_raw.jpg
```

---

### 3. å¯¹é½åçš„å®Œæ•´å›¾åƒ (`aligned.png`)

**ä½ç½®**: `save_stage1_result()` â†’ `runs/stage1/{chip_id}/aligned.png`

**åŠŸèƒ½**: ä¿å­˜å‡ ä½•æ ¡æ­£åçš„å®Œæ•´èŠ¯ç‰‡å›¾åƒ

**ä»£ç ä½ç½®**:
- `src/microfluidics_chip/core/io.py:79`

**è‡ªåŠ¨è¾“å‡º**: âœ… æ¯æ¬¡è¿è¡Œéƒ½ä¼šç”Ÿæˆ

---

### 2. æ•°æ®å¢å¼ºè¿‡ç¨‹å¯è§†åŒ– (`synthesis_*.png`) **[æ–°å¢]**

**ä½ç½®**: `visualize_synthesis.py` â†’ è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„

**åŠŸèƒ½**: å±•ç¤ºåˆæˆæ•°æ®ç”Ÿæˆçš„å„ä¸ªé˜¶æ®µ

**å¯è§†åŒ–å†…å®¹**ï¼ˆ2è¡Œ3åˆ—ï¼‰:

**ç¬¬ä¸€è¡Œ**:
1. **Original Clean**: åŸå§‹æ¸…æ´GTå›¾åƒ
2. **Concentration Mask**: æµ“åº¦æ©è†œï¼ˆçƒ­åŠ›å›¾ï¼Œä»…è…”å®¤åŒºåŸŸï¼‰
3. **Virtual Concentration**: é¢œè‰²æŠ–åŠ¨åçš„è™šæ‹Ÿæµ“åº¦å˜åŒ–

**ç¬¬äºŒè¡Œ**:
4. **Concentration Change**: æµ“åº¦å˜åŒ–å·®å¼‚å›¾
5. **Final Dirty Output**: æœ€ç»ˆåˆæˆç»“æœï¼ˆå«ç™½å¹³è¡¡+å…‰ç…§+å‡ ä½•+å™ªå£°ï¼‰
6. **Total Degradation**: æ€»é™è´¨ç¨‹åº¦ï¼ˆå·®å¼‚å›¾ï¼‰

**ä»£ç ä½ç½®**: 
- `src/microfluidics_chip/stage1_detection/synthesizer.py:251-336`

**ç¤ºä¾‹**:
```bash
# å¯è§†åŒ–å•å¼ å›¾åƒçš„åˆæˆè¿‡ç¨‹
python scripts/visualize_synthesis.py \
  dataset/clean_images/chip001.png \
  -o viz/synthesis_demo.png
```

**è¾“å‡ºç¤ºä¾‹**:
```
viz/
â””â”€â”€ synthesis_demo.png  # 6é¢æ¿å¯¹æ¯”å›¾
```

**é¢æ¿è¯´æ˜**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Original   â”‚Concentrationâ”‚  Virtual    â”‚
â”‚   Clean     â”‚    Mask     â”‚Concentrationâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚Concentrationâ”‚   Final     â”‚   Total     â”‚
â”‚   Change    â”‚Dirty Output â”‚ Degradation â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Stage2 å¯è§†åŒ–

### 1. è®­ç»ƒè¿‡ç¨‹å¯è§†åŒ– (`epoch_*_vis.png`)

**ä½ç½®**: `visualize_results()` â†’ `runs/training/epoch_{N}_vis.png`

**åŠŸèƒ½**: è®ºæ–‡çº§5é¢æ¿å¯¹æ¯”å›¾

**å¯è§†åŒ–å†…å®¹**ï¼ˆ1è¡Œ5åˆ—ï¼‰:
1. **Input (Dirty)**: å¹²æ‰°è¾“å…¥å›¾åƒ
2. **Ours Output**: æ¨¡å‹æ ¡æ­£è¾“å‡º
3. **Ground Truth**: ç†æƒ³ç›®æ ‡å›¾åƒ
4. **Error Before**: æ ¡æ­£å‰çš„è¯¯å·®çƒ­åŠ›å›¾ï¼ˆjet colormapï¼‰
5. **Error After (Ours)**: æ ¡æ­£åçš„è¯¯å·®çƒ­åŠ›å›¾ï¼ˆjet colormapï¼‰

**ä»£ç ä½ç½®**:
- `src/microfluidics_chip/stage2_correction/trainer.py:125-203`

**ç¤ºä¾‹**:
```bash
# è®­ç»ƒæ—¶è‡ªåŠ¨ç”Ÿæˆï¼ˆæ¯5ä¸ªepochï¼‰
python scripts/train_stage2.py data/training.npz -o runs/training
```

**è¾“å‡ºç¤ºä¾‹**:
```
runs/training/
â”œâ”€â”€ epoch_5_vis.png
â”œâ”€â”€ epoch_10_vis.png
â”œâ”€â”€ epoch_15_vis.png
...
â””â”€â”€ epoch_100_vis.png
```

**çƒ­åŠ›å›¾è¯´æ˜**:
- é¢œè‰²èŒƒå›´: 0-0.5ï¼ˆRGBè·ç¦»ï¼‰
- è“è‰²: è¯¯å·®å°ï¼ˆæ ¡æ­£æˆåŠŸï¼‰
- çº¢è‰²: è¯¯å·®å¤§ï¼ˆéœ€è¦æ”¹è¿›ï¼‰

---

## ğŸ“Š æ•°æ®å‡†å¤‡å¯è§†åŒ–

### 1. çœŸå®æ•°æ®å¤„ç†è°ƒè¯•å›¾ (`debug_*.png`)

**ä½ç½®**: `prepare_training_data.py` â†’ `dataset/{chip_dir}/debug_*.png`

**åŠŸèƒ½**: å±•ç¤ºGTå’ŒDirtyå›¾çš„æ£€æµ‹ç»“æœ

**æ–‡ä»¶ç±»å‹**:
- `debug_gt.png`: GTå›¾åƒæ£€æµ‹å¯è§†åŒ–
- `debug_dirty_01.png`: Dirtyå›¾1æ£€æµ‹å¯è§†åŒ–
- `debug_dirty_02.png`: Dirtyå›¾2æ£€æµ‹å¯è§†åŒ–
- ...

**ä»£ç ä½ç½®**:
- `scripts/prepare_training_data.py:96-97, 131-133`

**ç¤ºä¾‹**:
```bash
python scripts/prepare_training_data.py dataset/training -o data/train.npz
# è‡ªåŠ¨åœ¨æ¯ä¸ªèŠ¯ç‰‡ç›®å½•ç”Ÿæˆè°ƒè¯•å›¾
```

**è¾“å‡ºç¤ºä¾‹**:
```
dataset/training/chip001/
â”œâ”€â”€ gt.png
â”œâ”€â”€ dirty_01.png
â”œâ”€â”€ debug_gt.png        # â† æ–°ç”Ÿæˆ
â”œâ”€â”€ debug_dirty_01.png  # â† æ–°ç”Ÿæˆ
â””â”€â”€ ...
```

---

## ğŸ“ˆ å¯è§†åŒ–åŠŸèƒ½æ€»ç»“è¡¨

| é˜¶æ®µ | å¯è§†åŒ–ç±»å‹ | æ–‡ä»¶å | è‡ªåŠ¨ç”Ÿæˆ | CLIå¼€å…³ | ç”¨é€” |
|------|-----------|--------|---------|---------|------|
| **Stage1** | æ£€æµ‹è°ƒè¯•å›¾ | `debug_detection.png` | âœ… | `--save-debug/--no-save-debug` | æ£€æŸ¥æ£€æµ‹å’Œåˆ‡ç‰‡ |
| **Stage1** | å•ä¸ªåˆ‡ç‰‡ | `slices/{i}_raw.jpg` | âŒ | `--save-slices` | æŸ¥çœ‹æ¯ä¸ªè…”å®¤ |
| **Stage1** | å¯¹é½å›¾åƒ | `aligned.png` | âœ… | - | å‡ ä½•æ ¡æ­£ç»“æœ |
| **Stage2** | è®­ç»ƒå¯è§†åŒ– | `epoch_{N}_vis.png` | âœ… | - | è®­ç»ƒæ•ˆæœå¯¹æ¯” |
| **æ•°æ®å‡†å¤‡** | GTæ£€æµ‹å›¾ | `debug_gt.png` | âœ… | `--no-debug` | æ£€æŸ¥GTå¤„ç† |
| **æ•°æ®å‡†å¤‡** | Dirtyæ£€æµ‹å›¾ | `debug_dirty_*.png` | âœ… | `--no-debug` | æ£€æŸ¥Dirtyå¤„ç† |

---

## ğŸ¨ å¯è§†åŒ–é…è‰²æ–¹æ¡ˆ

### Stage1 æ£€æµ‹å›¾
```python
è“è‰² (255, 0, 0)  # è…”å®¤ä¸­å¿ƒç‚¹
é»„è‰² (255, 255, 0) # åˆ‡ç‰‡è¾¹ç•Œæ¡†
çº¢è‰² (0, 0, 255)   # ç©ºç™½è…”æ ‡è®°
```

### Stage2 è¯¯å·®çƒ­åŠ›å›¾
```python
Colormap: 'jet'
èŒƒå›´: 0.0 - 0.5 (RGBè·ç¦»)
è“â†’ç»¿â†’é»„â†’çº¢ (è¯¯å·®å¢å¤§)
```

---

## ğŸ”§ ä½¿ç”¨å»ºè®®

### è°ƒè¯•Stage1æ£€æµ‹é—®é¢˜
```bash
# å¯ç”¨æ‰€æœ‰è°ƒè¯•è¾“å‡º
python -m microfluidics_chip.pipelines.cli stage1 \
  image.png \
  -o runs/debug \
  --save-debug \
  --save-slices
```

**æ£€æŸ¥é¡ºåº**:
1. æŸ¥çœ‹ `debug_detection.png` â†’ ç¡®è®¤12ä¸ªè…”å®¤éƒ½è¢«æ£€æµ‹åˆ°
2. ç¡®è®¤ç©ºç™½è…”ï¼ˆçº¢åœˆï¼‰ä½ç½®æ­£ç¡®
3. æŸ¥çœ‹ `slices/` â†’ ç¡®è®¤æ¯ä¸ªåˆ‡ç‰‡å±…ä¸­ä¸”å®Œæ•´

### ç›‘æ§Stage2è®­ç»ƒ
```bash
# è®­ç»ƒæ—¶è‡ªåŠ¨ç”Ÿæˆå¯è§†åŒ–
python scripts/train_stage2.py data/training.npz -o runs/exp1

# å®æ—¶æŸ¥çœ‹è®­ç»ƒæ•ˆæœ
ls runs/exp1/epoch_*_vis.png
```

**æ£€æŸ¥é‡ç‚¹**:
1. **Error After** æ˜¯å¦æ¯” **Error Before** æ›´è“ï¼ˆè¯¯å·®æ›´å°ï¼‰
2. **Ours Output** æ˜¯å¦æ¥è¿‘ **Ground Truth**
3. çƒ­åŠ›å›¾ä¸­å¿ƒåŒºåŸŸï¼ˆROIï¼‰çš„è¯¯å·®æ˜¯å¦æ˜æ˜¾é™ä½

---

## ğŸ“‹ å½“å‰ç¼ºå¤±çš„å¯è§†åŒ–

ä»¥ä¸‹æ˜¯å¯èƒ½éœ€è¦æ·»åŠ çš„å¯è§†åŒ–åŠŸèƒ½ï¼š

### Stage1
- âŒ YOLOåŸå§‹æ£€æµ‹æ¡†å¯è§†åŒ–ï¼ˆå½“å‰åªæ˜¾ç¤ºä¸­å¿ƒç‚¹ï¼‰
- âŒ å‡ ä½•å˜æ¢å‚æ•°å¯è§†åŒ–ï¼ˆå˜æ¢çŸ©é˜µã€æ—‹è½¬è§’åº¦ç­‰ï¼‰
- âŒ æ‰¹å¤„ç†ç»Ÿè®¡å›¾ï¼ˆæ£€æµ‹æˆåŠŸç‡ã€å¤„ç†æ—¶é—´åˆ†å¸ƒï¼‰

### Stage2
- âŒ è®­ç»ƒæ›²çº¿å›¾ï¼ˆLoss/PSNR vs Epochï¼‰
- âŒ æ‰¹é‡æµ‹è¯•å¯è§†åŒ–ï¼ˆå¯¹æ¯”å¤šä¸ªæ ·æœ¬ï¼‰
- âŒ å…‰ç…§æ ¡æ­£å‰åçš„ç›´æ–¹å›¾å¯¹æ¯”
- âŒ ROIåŒºåŸŸæƒé‡å¯è§†åŒ–

### æ•°æ®å‡†å¤‡
- âŒ æ•°æ®é›†åˆ†å¸ƒç»Ÿè®¡ï¼ˆè…”å®¤æ•°é‡ã€å›¾åƒè´¨é‡åˆ†å¸ƒï¼‰
- âŒ åˆæˆå‚æ•°å¯è§†åŒ–ï¼ˆç™½å¹³è¡¡ã€å…‰ç…§åœºç­‰ï¼‰

---

## ğŸ’¡ æ‰©å±•å»ºè®®

### 1. äº¤äº’å¼å¯è§†åŒ–ï¼ˆStreamlit/Gradioï¼‰
```python
# å¯åˆ›å»ºWebç•Œé¢
- ä¸Šä¼ å›¾åƒ â†’ å®æ—¶æ˜¾ç¤ºæ£€æµ‹ç»“æœ
- æ‹–åŠ¨å‚æ•°æ»‘å— â†’ è°ƒæ•´åˆæˆå‚æ•°
- å¯¹æ¯”å¤šä¸ªæ¨¡å‹çš„è¾“å‡º
```

### 2. TensorBoardé›†æˆ
```python
# æ·»åŠ åˆ°trainer.py
from torch.utils.tensorboard import SummaryWriter
writer = SummaryWriter('runs/stage2_training')
writer.add_image('train/input', ...)
writer.add_scalar('train/loss', ...)
```

### 3. æ‰¹é‡å¯¹æ¯”æŠ¥å‘Š
```python
# ç”ŸæˆHTMLæŠ¥å‘Š
- æ‰¹é‡å¤„ç†ç»“æœ
- æ¯ä¸ªæ ·æœ¬çš„5é¢æ¿å¯¹æ¯”
- ç»Ÿè®¡æŒ‡æ ‡æ±‡æ€»ï¼ˆå¹³å‡PSNRã€SSIMç­‰ï¼‰
```

---

**æ€»ç»“**: å½“å‰å·²å®ç°åŸºç¡€çš„è°ƒè¯•å’Œè®­ç»ƒå¯è§†åŒ–ï¼Œå¯æ»¡è¶³åŸºæœ¬å¼€å‘éœ€æ±‚ã€‚å¦‚éœ€æ›´é«˜çº§çš„åˆ†æï¼Œå»ºè®®æ·»åŠ è®­ç»ƒæ›²çº¿ã€ç»Ÿè®¡æŠ¥å‘Šå’Œäº¤äº’å¼ç•Œé¢ã€‚
