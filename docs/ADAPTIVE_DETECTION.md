# Stage1 æ£€æµ‹ç²¾åº¦æå‡æ–¹æ¡ˆ

> **ç›®æ ‡**: ç¡®ä¿åœ¨å¤æ‚å…‰ç…§ã€å°ºåº¦å˜åŒ–æ¡ä»¶ä¸‹ç¨³å®šæ£€æµ‹ 12 ä¸ªè…”å®¤ï¼Œå¹¶æ­£ç¡®è¯†åˆ«å”¯ä¸€çš„æš—è…”å®¤
>
> **æ–‡æ¡£è¾¹ç•Œ**: æœ¬æ–‡æ¡£èšç„¦ Stage1 è‡ªé€‚åº”æ£€æµ‹ä¸æ‹“æ‰‘ç­–ç•¥ã€‚å®Œæ•´ CLI å‘½ä»¤è¯·ä»¥ `docs/CLI_REFERENCE.md` ä¸ºå‡†ï¼š
> - å‘½ä»¤å…¥å£ï¼š[`docs/CLI_REFERENCE.md`](./CLI_REFERENCE.md)
> - æ–‡æ¡£å¯¼èˆªï¼š[`docs/README.md`](./README.md)

---

## ğŸ¯ æ•´ä½“æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ•°æ®å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å•ç±»åˆ«æ ‡ç­¾  ->  åˆ†å±‚å¢å¼º (mild/medium/extreme)  ->  å¢å¼ºæ•°æ®é›†  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ¨ç†å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸå›¾ -> ç²—æ‰«æ -> DBSCANèšç±» -> ROIæå– -> ç²¾æ‰«æ -> æ‹“æ‰‘æ‹Ÿåˆ   â”‚
â”‚        -> è´¨é‡é—¸é—¨(æ‹Ÿåˆ/è¯¯å·®/ç½®ä¿¡åº¦) -> é€šè¿‡ or è‡ªåŠ¨é‡è¯•         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ç¬¬1å±‚ï¼šæ•°æ®ä¸æ ‡ç­¾ç­–ç•¥

### 1.1 å•ç±»åˆ«æ ‡ç­¾è¿ç§»

å°†åŸæœ‰çš„ `chamber_dark` / `chamber_lit` åˆå¹¶ä¸ºç»Ÿä¸€çš„ `chamber` ç±»åˆ«ï¼Œæš—è…”å®¤åˆ¤å®šç§»è‡³æ¨ç†å±‚ã€‚

```bash
# å…ˆé¢„è§ˆ
python scripts/migrate_labels_to_single_class.py --data yolo_v3 --dry-run

# ç¡®è®¤åæ‰§è¡Œ
python scripts/migrate_labels_to_single_class.py --data yolo_v3
```

### 1.2 åˆ†å±‚ç¦»çº¿å¢å¼º (v2.3)

| æ¡£ä½ | æ¯”ä¾‹ | å…‰ç…§å¼ºåº¦ | å…‰å­è®¡æ•° | é€‚ç”¨åœºæ™¯ |
|------|------|----------|----------|----------|
| mild | 70% | 0.1-0.3 | 60-100 | æ­£å¸¸æ¡ä»¶ |
| medium | 25% | 0.3-0.5 | 40-60 | è½»å¾®é€€åŒ– |
| extreme | 5% | 0.5-0.8 | 20-40 | æç«¯æ¡ä»¶ |

**å…³é”®æ”¹è¿›**ï¼š
- CLAHE é»˜è®¤åœ¨é€€åŒ–**ä¹‹å**æ‰§è¡Œï¼Œé¿å…äºŒæ¬¡å™ªå£°æ”¾å¤§
- æ¯å‰¯æœ¬ç‹¬ç«‹é¢„å¤„ç†ï¼Œå¢åŠ å¤šæ ·æ€§
- è´¨é‡æ§åˆ¶æœºåˆ¶ï¼Œé˜²æ­¢ extreme äº§ç”Ÿä¸å¯ç”¨æ ·æœ¬
- é»˜è®¤å¢å¼º `train` å¹¶åŒæ­¥å¤åˆ¶ `val/test`ï¼›å¦‚åªéœ€ trainï¼Œå¯åŠ  `--no-sync-splits`

```bash
# æ¨èç”¨æ³• (é»˜è®¤: multiplier=3, prob=0.7)
python scripts/augment_yolo_dataset.py \
    --input data/stage1_detection/yolo_v3/images/train

# è‡ªå®šä¹‰é…ç½®
python scripts/augment_yolo_dataset.py \
    --input data/stage1_detection/yolo_v3/images/train \
    --multiplier 2 --prob 0.8 \
    --clahe-position before_degradation \
    --invert-prob 0.05 --verbose

# å¦‚æœä½ åªæƒ³è¾“å‡º trainï¼ˆä¸å¤åˆ¶ val/testï¼‰
python scripts/augment_yolo_dataset.py \
    --input data/stage1_detection/yolo_v3/images/train \
    --no-sync-splits
```

---

## ğŸ” ç¬¬2å±‚ï¼šè‡ªé€‚åº”æ¨ç† Pipeline

### 2.1 ç²—åˆ°ç²¾æ£€æµ‹ (AdaptiveDetector)

| é˜¶æ®µ | ç½®ä¿¡åº¦ | åˆ†è¾¨ç‡ | ç›®çš„ |
|------|--------|--------|------|
| ç²—æ‰«æ | 0.15 | åŸå›¾ | æ‰¾åˆ°å¤§è‡´åŒºåŸŸ |
| ROI æå– | - | DBSCAN èšç±» | è‡ªåŠ¨å®šä½èŠ¯ç‰‡ |
| ç²¾æ‰«æ | 0.4 | ROI + CLAHE | ç²¾ç¡®æ£€æµ‹ |

### 2.2 æ‹“æ‰‘çº¦æŸæ‹Ÿåˆ (TopologyFitter)

**ç”ŸåŒ–èƒŒæ™¯ä¸æ£€æµ‹åŸç†**ï¼š
- **å‚è€ƒè‡‚ (Reference Arm)**ï¼š
    - **æš—è…”å®¤ (Dark Chamber)**ï¼šä½äºæœ€å¤–ä¾§ã€‚**åªå«å¾…æµ‹æ¶²**ï¼ˆæ— é…¶ã€æ— çº³ç±³é¢—ç²’ï¼‰ã€‚å› æ­¤å‘ˆç°**æœ€ä½äº®åº¦**ã€‚
    - **å…¶ä»–è…”å®¤**ï¼šå«å¾…æµ‹æ¶² + é…¶ï¼ˆæ— çº³ç±³é¢—ç²’ï¼‰ã€‚äº®åº¦å¯èƒ½ä¸ä½ï¼Œå› æ­¤**ä¸èƒ½**ä½œä¸ºåˆ¤å®šä¾æ®ã€‚
- **ååº”è‡‚ (Reaction Arms)**ï¼š
    - 3æ¡è‡‚åˆ†åˆ«æ£€æµ‹è‘¡è„ç³–/å°¿é…¸/èƒ†å›ºé†‡ã€‚
    - å«å¾…æµ‹æ¶² + é…¶ + **çº³ç±³é¢—ç²’**ã€‚
    - çº³ç±³é¢—ç²’é€šå¸¸å¼•å…¥æ˜¾è‰²/è§å…‰/æµŠåº¦ï¼Œä½¿å¾—å…¶æœ€å¤–ä¾§è…”å®¤æ˜¾è‘—äº®äºæš—è…”å®¤ã€‚

**åˆ¤å®šæ ¸å¿ƒé€»è¾‘**ï¼š
åˆ©ç”¨ **"æœ‰æ— çº³ç±³é¢—ç²’"** äº§ç”Ÿçš„ç‰©ç†å¤–è§‚å·®å¼‚ï¼Œå¯¹æ¯” 4 ä¸ªè‡‚çš„**æœ€å¤–ä¾§**è…”å®¤ã€‚
- **ç›®æ ‡**ï¼šå¯»æ‰¾å”¯ä¸€çš„â€œçº¯å¾…æµ‹æ¶²â€è…”å®¤ã€‚
- **ç­–ç•¥**ï¼šå¿½ç•¥è‡‚ä¸Šä¸­é—´è…”å®¤ï¼ˆæ’é™¤å¹²æ‰°ï¼‰ï¼Œåªé€šè¿‡æœ€å¤–ä¾§çš„â€œæš—è…”å®¤ candidateâ€ä¸å…¶ä½™ 3 ä¸ªâ€œååº”è…”å®¤â€å¯¹æ¯”ã€‚

**åå­—æ¨¡æ¿ç»“æ„**ï¼ˆç¡¬ç¼–ç å…ˆéªŒï¼‰ï¼š
```
          0
          1
          2 â† æœ€å¤–ä¾§ (å€™é€‰æš—è…”å®¤)
  9 10 11     3 4 5
          6
          7
          8 â† æœ€å¤–ä¾§ (å€™é€‰æš—è…”å®¤)
```

| ç‰¹æ€§ | å€¼ |
|------|-----|
| è‡‚æ•° | 4 æ¡ |
| æ¯è‡‚è…”å®¤æ•° | 3 ä¸ª |
| ä¸­å¿ƒè…”å®¤ | **æ— ** |
| æš—è…”å®¤æ•°é‡ | **å”¯ä¸€ 1 ä¸ª** |
| æš—è…”å®¤ä½ç½® | è‡‚æœ€å¤–ä¾§ `[2, 5, 8, 11]` |

**æš—è…”å®¤åˆ¤å®šé€»è¾‘ (v1.4 Safety First)**ï¼š
1. **èŒƒå›´é”å®š**ï¼šåªåœ¨ 4 ä¸ªæœ€å¤–ä¾§ä½ç½®å¯»æ‰¾ã€‚
2. **å¼ºåˆ¶ç«æ‹©**ï¼šé€‰å‡ºå…¶ä¸­äº®åº¦æœ€ä½çš„ Candidateã€‚
3. **åŒé‡ä¿é™©éªŒè¯**ï¼š
    - **å¼ºè¯æ®** (`Ratio < 0.80`)ï¼šâœ… å·®å¼‚æ˜¾è‘—ï¼Œç›´æ¥ç¡®ä¿¡ã€‚
    - **å¼±è¯æ®** (`Ratio < 0.90` AND `Value < 80`)ï¼šâœ… å·®å¼‚ä¸­ç­‰ä½†ä½ç½®ç¡®å®å¾ˆé»‘ï¼Œç¡®ä¿¡ã€‚
    - **è¯æ®ä¸è¶³**ï¼šâŒ è¿”å›ç©ºã€‚**å®å¯æ¼åˆ¤ (Fail Fast)ï¼Œä¸å¯è¯¯åˆ¤ (é˜²æ­¢ Stage 2 åŸºå‡†é”™è¯¯)**ã€‚

**RANSAC æ‹Ÿåˆ**ï¼š
- ä½¿ç”¨ Similarity Transformï¼ˆæ—‹è½¬ + ç¼©æ”¾ + å¹³ç§»ï¼‰
- æœ€å°‘éœ€è¦ 4 ä¸ªå†…ç‚¹
- è‡ªåŠ¨å›å¡«æ¼æ£€è…”å®¤åæ ‡

### 2.3 è´¨é‡é—¸é—¨ä¸è‡ªåŠ¨é‡è¯• (v2.1)

Stage1 æ–°å¢è¿è¡Œæ—¶è´¨é‡æ§åˆ¶ï¼Œç”¨äºä¿æŠ¤ Stage2 è¾“å…¥ç¨³å®šæ€§ã€‚

**é—¸é—¨æ ¸å¿ƒæŒ‡æ ‡**ï¼š
- `fit_success`
- `inlier_ratio`
- `reprojection_error`
- `detection_count`
- `cluster_score`
- `mean_confidence`

**é»˜è®¤ç­–ç•¥**ï¼š
- æœ€å¤šé‡è¯• 3 æ¬¡
- é¢„å¤„ç†è½®æ¢ï¼š`raw -> clahe -> clahe_invert`
- æ¯æ¬¡é‡è¯•é™ä½ `coarse_conf/fine_conf`ï¼Œå¹¶æå‡ `fine_imgsz`
- è‹¥ä»ä¸è¾¾æ ‡ï¼Œå¯å›é€€æ ‡å‡†æ£€æµ‹æµç¨‹

**å…³é”®é…ç½®ä½ç½®**ï¼š`configs/default.yaml` -> `stage1.adaptive_runtime`

---

## ğŸ› ï¸ å…³é”®æ–‡ä»¶

| ç±»å‹ | æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|------|
| è„šæœ¬ | `scripts/migrate_labels_to_single_class.py` | æ ‡ç­¾è¿ç§» |
| è„šæœ¬ | `scripts/augment_yolo_dataset.py` (v2.3) | ç¦»çº¿å¢å¼º |
| è„šæœ¬ | `scripts/train_yolo.py` | YOLO è®­ç»ƒ |
| æ ¸å¿ƒ | `stage1_detection/preprocess.py` | ç»Ÿä¸€é¢„å¤„ç† |
| æ ¸å¿ƒ | `stage1_detection/adaptive_detector.py` | ç²—åˆ°ç²¾æ£€æµ‹ |
| æ ¸å¿ƒ | `stage1_detection/topology_fitter.py` | RANSAC æ‹Ÿåˆ |
| å…¥å£ | `stage1_detection/inference.py` | `infer_stage1_adaptive()` |
| ç¼–æ’ | `pipelines/stage1.py` | è´¨é‡é—¸é—¨ + è‡ªåŠ¨é‡è¯• |
| é…ç½® | `core/config.py` | `AdaptiveRuntimeConfig` |
| é…ç½® | `configs/adaptive_detection.yaml` | å‚æ•°æ¨¡æ¿ |
| é…ç½® | `configs/default.yaml` | è¿è¡Œç­–ç•¥é»˜è®¤å€¼ |
| ç¤ºä¾‹ | `examples/adaptive_detection_demo.py` | ç«¯åˆ°ç«¯æ¼”ç¤º |

---

## ğŸš€ æœ€å°é—­ç¯æµç¨‹

```bash
# Step 1: æ ‡ç­¾è¿ç§»
python scripts/migrate_labels_to_single_class.py --data yolo_v3

# Step 2: æ•°æ®å¢å¼º
python scripts/augment_yolo_dataset.py --input data/stage1_detection/yolo_v3/images/train

# Step 3: é‡æ–°è®­ç»ƒ YOLOï¼ˆæ— éªŒè¯é›†æ—¶å»ºè®®åŠ  --no-valï¼‰
# è‡ªåŠ¨æ¨¡å¼ï¼ˆæ¨èï¼‰ï¼šè‡ªåŠ¨é€‰æ‹©å¯è§ GPUï¼ˆ1 å¡=å•å¡ï¼Œ>=2 å¡=å¤šå¡ï¼‰
python scripts/train_yolo.py --data yolo_v3_augmented --name chambers_v21 --no-val --mode auto --gpus all

# å•å¡æ¨¡å¼ï¼ˆç¤ºä¾‹ï¼šåªç”¨ GPU0ï¼‰
python scripts/train_yolo.py --data yolo_v3_augmented --name chambers_v21 --no-val --mode single --gpus 0

# å¤šå¡æ¨¡å¼ï¼ˆç¤ºä¾‹ï¼šGPU0,1ï¼›æ¯å¡ batch=8ï¼Œæ€» batch=16ï¼‰
python scripts/train_yolo.py --data yolo_v3_augmented --name chambers_v21 --no-val --mode multi --gpus 0,1 --batch-per-gpu 8

# Step 4: Stage1 è‡ªé€‚åº”æ¨ç†ï¼ˆå•å›¾ï¼Œå…³æ³¨æœ¬ä¸“é¢˜ï¼‰
python -m microfluidics_chip.pipelines.cli stage1 \
  data/chip001.png \
  -o data/experiments/stage1 \
  --adaptive

# Step 5: Stage1 è‡ªé€‚åº”æ¨ç†ï¼ˆæ‰¹é‡ï¼Œå…³æ³¨æœ¬ä¸“é¢˜ï¼‰
python -m microfluidics_chip.pipelines.cli stage1-batch \
  data/images \
  -o data/experiments/stage1_batch \
  --adaptive
```

Stage2 ä¸æ¶ˆèå‘½ä»¤ï¼ˆ`stage1-yolo` / `stage1-yolo-adaptive` / `stage1-post`ï¼‰å®Œæ•´å‚æ•°è¡¨è¯·æŸ¥çœ‹ `docs/CLI_REFERENCE.md`ã€‚

`stage1_metadata.json` ä¸­å¯é‡ç‚¹å…³æ³¨ï¼š`quality_metrics`ã€`quality_gate_passed`ã€`detection_mode`ã€`retry_attempt`ã€‚

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | åŸæ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ |
|------|--------|--------|
| æ£€æµ‹å¬å›ç‡ | ~80-90% | ~95%+ (æ‹“æ‰‘å›å¡«) |
| æš—è…”å®¤è¯†åˆ« | ä¾èµ–æ£€æµ‹ | æ‹“æ‰‘çº¦æŸ + äº®åº¦åˆ¤å®š |
| å°ºåº¦é²æ£’æ€§ | å•å°ºåº¦ | ç²—åˆ°ç²¾è‡ªé€‚åº” |
| å…‰ç…§é²æ£’æ€§ | ä¸€èˆ¬ | CLAHE + åˆ†å±‚å¢å¼º |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [YOLO_OPTIMIZATION.md](./YOLO_OPTIMIZATION.md) - YOLO è°ƒå‚æŠ€å·§
- [AUGMENTATION_VALIDATION.md](./AUGMENTATION_VALIDATION.md) - å¢å¼ºéªŒè¯æ–¹æ³•
- [DATA_PREPARATION.md](./DATA_PREPARATION.md) - æ•°æ®å‡†å¤‡æµç¨‹
